//   BronsonJS - v1.0.0 - 2013-01-22
//   http://github.com/eclifford/bronson/
//   Copyright (c) 2013 Eric Clifford; Licensed MIT
(function(){var e=[].slice,t={}.hasOwnProperty;(function(e,t){return typeof define=="function"&&define.amd?define([],t()):e.Bronson=t()})(this,function(){var n,r,i;return n=window.Bronson={version:"1.0.0",debug:!1,events:{},modules:{},publish:function(e){var t,n,r,i,s,o,u,a,f,l;o=/^[a-z]+((:[a-z]+){1})$/,i=e.toLowerCase();if(!o.test(i))throw new Error("Bronson.publish: event "+i+" must be in format subscriber or channel:topic");s=i.split(":"),r=s[0],l=s[1];if(!this.events[r][l])return!0;f=this.events[r][l].slice(),n=[].slice.call(arguments,1);for(u=0,a=f.length;u<a;u++)t=f[u],t.callback.apply(this,n);if(this.debug)return console.log("Bronson.publish: "+i)},subscribe:function(e,t,r){var i,s,o,u,a,f;u=/^[a-z]+((:[a-z]+){2})$/,s=e.toLowerCase();if(!u.test(s))throw new Error("Bronson.subscribe: event "+s+" must be in format subscriber or subscriber:channel:topic");if(t!=null&&typeof t!="function")throw new Error("Bronson.subscribe: callback must be a function");o=s.split(":"),a=o[0],i=o[1],f=o[2];if(n.Permissions.enabled&&!n.Permissions.rules[a][i])throw new Error("Bronson#.subscribe: attempting to subscribe to channel "+i+" which is not permmitted by current permissions");this.events[i]||(this.events[i]={}),this.events[i][f]=this.events[i][f]?this.events[i][f]:[],this.events[i][f].push({subscriber:a,context:r||this,callback:t});if(this.debug)return console.log("Bronson.subscribe: "+s)},unsubscribe:function(e){var t,n,r,i,s,o,u,a,f,l,c,h;o=/^[a-z]+((:[a-z]+){2})?$/,i=e.toLowerCase();if(!o.test(i))throw new Error("Bronson.unsubscribe: event "+i+" must be in format subscriber or subscriber:channel:topic");s=i.split(":"),c=s[0],r=s[1],h=s[2];if(s.length===1){l=[];for(r in this.events)l.push(function(){var e;e=[];for(h in this.events[r])e.push(function(){var e,i,s,o;s=this.events[r][h],o=[];for(t=e=0,i=s.length;e<i;t=++e){n=s[t];if(n.subscriber===c){this.events[r][h].splice(t,1);break}o.push(void 0)}return o}.call(this));return e}.call(this));return l}f=this.events[r][h];for(t=u=0,a=f.length;u<a;t=++u){n=f[t];if(n.subscriber===c){this.events[r][h].splice(t,1);return}}},load:function(e,t,n,r){var i=this;r==null&&(r=!0);if(e==null||typeof e!="string")throw new Error("Bronson.load: must supply a valid module");if(n!=null&&typeof n!="function")throw new Error("Bronson.load: callback must be in the form of a function");if(r!=null&&typeof r!="boolean")throw new Error("Bronson.load: autostart must be a valid boolean");return require(["module",e],function(s,o){var u;try{return u=new o(t),u.id=s.id,i.modules[e]=i.modules[e]?i.modules[e]:[],i.modules[e].push(u),u.load(),window.module=u,r&&u.start(),n(u)}catch(a){throw new Error("Bronson.load: "+a)}},function(e){var t;throw e.requireType==="timeout"?new Error:(t=e.requireModules&&e.requireModules[0],require.undef(t),e)})},unload:function(e){var t,n,r,i,s,o,u,a,f,l,c;if(e==null||typeof e!="string")throw new Error("Bronson.unload: id must be valid");try{for(i in this.modules)if(this.modules.hasOwnProperty(i)){l=this.modules[i];for(s=o=0,a=l.length;o<a;s=++o){n=l[s];if(n.id===e){n.unload(),this.modules[i].splice(s,1);return}}}this.modules[i].length===0&&(require.undef(i),delete this.modules[i]),t=require.s.contexts._.defined,c=[];for(u=0,f=t.length;u<f;u++)r=t[u],t.hasOwnProperty(r)&&r.indexOf(channel)!==-1?c.push(require.undef(r)):c.push(void 0);return c}catch(h){throw new Error("Bronson.unload: "+h)}},unloadAll:function(){var e,t,n;n=[];for(t in this.modules)this.modules.hasOwnProperty(t)?n.push(function(){var n,r,i,s;i=this.modules[t],s=[];for(n=0,r=i.length;n<r;n++)e=i[n],s.push(this.unloadModule(e.id));return s}.call(this)):n.push(void 0);return n},start:function(e){var t,n,r,i,s,o;for(n in this.modules)if(this.modules.hasOwnProperty(n)){o=this.modules[n];for(r=i=0,s=o.length;i<s;r=++i){t=o[r];if(t.id===e){t.start();return}}}},stop:function(e){var t,n,r,i,s;for(n in this.modules)if(this.modules.hasOwnProperty(n)){s=this.modules[n];for(r=0,i=s.length;r<i;r++){t=s[r];if(t.id===e){t.stop();return}}}},stopAll:function(){var e,t,n;n=[];for(t in this.modules)this.modules.hasOwnProperty(t)?n.push(function(){var n,r,i,s;i=this.modules[t],s=[];for(n=0,r=i.length;n<r;n++)e=i[n],s.push(e.stop());return s}.call(this)):n.push(void 0);return n}},n.on=n.subscribe,n.trigger=n.publish,i=n.Util={extend:function(){var n,r,i,s,o,u,a;i=arguments[0],n=2<=arguments.length?e.call(arguments,1):[];if(i==null)return{};for(u=0,a=n.length;u<a;u++){s=n[u];for(r in s){if(!t.call(s,r))continue;o=s[r],i[r]==null||typeof o!="object"?i[r]=o:i[r]=this.extend(i[r],o)}}return i}},r=n.Permissions={enabled:!1,rules:{},set:function(e){return this.rules=n.Util.extend(this.rules,e)},validate:function(e,t){var n,r;if(e==null||typeof e!="string")throw new Error("Bronson.Permissions.validate: must provide a valid subscriber");if(t==null||typeof t!="string")throw new Error("Bronson.Permissions.validate: must provide a valid channel");return this.enabled?(n=(r=this.rules[e])!=null?r[t]:void 0,n===void 0?!1:n):!0}},n.Module=function(){function e(){}return e.prototype.id="",e.prototype.disposed=!1,e.prototype.started=!1,e.prototype.load=function(){throw new Error("Bronson.Module.initialize: must override initialize")},e.prototype.start=function(){return this.started=!0},e.prototype.stop=function(){return this.started=!1},e.prototype.unload=function(){if(this.disposed)return;return this.disposed=!0,typeof Object.freeze=="function"?Object.freeze(this):void 0},e}(),n})}).call(this);